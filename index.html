import React, { useState, useEffect, useRef } from 'react';
import { Settings, Trash2, Trophy, Users, Upload, FileSpreadsheet, Info, CheckCircle, Globe, UserMinus } from 'lucide-react';

// --- زبانوں کا ڈیٹا (Translations) ---
const translations = {
  ur: {
    title: "قرعہ اندازی",
    subtitle: "اپنے پسندیدہ فاتح کا انتخاب کریں!",
    info: "یہ ویب سائٹ قرعہ اندازی کو شفاف اور آسان بنانے کے لیے ہے۔ آپ ایک فاتح چن سکتے ہیں یا نیچے باکس میں تعداد لکھ کر بیک وقت متعدد فاتحین منتخب کر سکتے ہیں۔",
    participants: "شرکاء",
    addFile: "فائل شامل کریں",
    clearTitle: "فہرست صاف کریں",
    settingsTitle: "ترتیبات",
    theme: "رنگین تھیم",
    duration: "دورانیہ",
    seconds: "سیکنڈ",
    removeWinner: "فاتح کو فہرست سے ہٹا دیں (دوبارہ نہیں آئے گا)",
    removeWinnerShort: "فاتح کو فہرست سے خارج کریں",
    confetti: "خوشی کا اظہار (Confetti)",
    done: "مکمل",
    ready: "تیار ہیں؟",
    winnerLabel: "فاتح ہے",
    currentPickLabel: "موجودہ انتخاب",
    spinning: "انتخاب ہو رہا ہے...",
    reset: "دوبارہ شروع کریں",
    pickOne: "قرعہ اندازی شروع کریں",
    pickMulti: "{n} فاتحین چنیں",
    numWinners: "فاتحین کی تعداد:",
    recent: "حالیہ ریکارڈ",
    winnersList: "فاتحین کی فہرست",
    placeholder: "یہاں نام لکھیں، ہر لائن میں ایک...",
    alertEmpty: "براہ کرم پہلے کچھ نام درج کریں!",
    alertCount: "آپ نے {n} فاتحین مانگے ہیں لیکن فہرست میں صرف {t} لوگ ہیں۔",
    alertMin: "کم از کم 1 فاتح ہونا ضروری ہے۔",
    confirmClear: "کیا آپ تمام نام صاف کرنا چاہتے ہیں؟",
    uploadError: "فائل میں خرابی ہے یا فارمیٹ درست نہیں",
    uploadBtn: "فائل",
    footer: "قرعہ اندازی • ایکسل سپورٹ • ملٹی ونرز"
  },
  en: {
    title: "Giveaway Picker",
    subtitle: "Pick your winner fairly and easily!",
    info: "This website makes giveaways transparent and easy. You can pick a single winner or select multiple winners at once by entering the count below.",
    participants: "Participants",
    addFile: "Add File",
    clearTitle: "Clear List",
    settingsTitle: "Settings",
    theme: "Color Theme",
    duration: "Duration",
    seconds: "sec",
    removeWinner: "Remove winner from list (won't win again)",
    removeWinnerShort: "Remove winner after picking",
    confetti: "Celebration Confetti",
    done: "Done",
    ready: "Ready?",
    winnerLabel: "The Winner Is",
    currentPickLabel: "Current Pick",
    spinning: "Picking...",
    reset: "Start Over",
    pickOne: "Pick Winner",
    pickMulti: "Pick {n} Winners",
    numWinners: "Number of Winners:",
    recent: "Recent History",
    winnersList: "Winners List",
    placeholder: "Enter names here, one per line...",
    alertEmpty: "Please enter some names first!",
    alertCount: "You asked for {n} winners but there are only {t} people in the list.",
    alertMin: "At least 1 winner is required.",
    confirmClear: "Do you want to clear the entire list?",
    uploadError: "Error reading file or invalid format",
    uploadBtn: "File",
    footer: "Giveaway Picker • Excel Support • Multi-Winners"
  },
  ar: {
    title: "سحب القرعة",
    subtitle: "اختر الفائز المفضل لديك بنزاهة!",
    info: "تم تصميم هذا الموقع لجعل الهدايا شفافة وسهلة. يمكنك اختيار فائز واحد أو اختيار عدة فائزين في وقت واحد عن طريق إدخال العدد أدناه.",
    participants: "المشاركون",
    addFile: "إضافة ملف",
    clearTitle: "مسح القائمة",
    settingsTitle: "الإعدادات",
    theme: "لون الثيم",
    duration: "المدة",
    seconds: "ثواني",
    removeWinner: "إزالة الفائز من القائمة (لن يفوز مرة أخرى)",
    removeWinnerShort: "إزالة الفائز من القائمة",
    confetti: "احتفال (Confetti)",
    done: "تم",
    ready: "مستعد؟",
    winnerLabel: "الفائز هو",
    currentPickLabel: "الاختيار الحالي",
    spinning: "جاري الاختيار...",
    reset: "ابدأ من جديد",
    pickOne: "اختر الفائز",
    pickMulti: "اختر {n} فائزين",
    numWinners: "عدد الفائزين:",
    recent: "السجل الحديث",
    winnersList: "قائمة الفائزين",
    placeholder: "أدخل الأسماء هنا، اسم واحد في كل سطر...",
    alertEmpty: "الرجاء إدخال بعض الأسماء أولاً!",
    alertCount: "لقد طلبت {n} فائزين ولكن يوجد فقط {t} أشخاص في القائمة.",
    alertMin: "مطلوب فائز واحد على الأقل.",
    confirmClear: "هل تريد مسح القائمة بالكامل؟",
    uploadError: "خطأ في قراءة الملف",
    uploadBtn: "ملف",
    footer: "سحب القرعة • دعم إكسل • فائزون متعددون"
  },
  hi: {
    title: "लकी ड्रॉ",
    subtitle: "अपने विजेता को निष्पक्ष रूप से चुनें!",
    info: "यह वेबसाइट लकी ड्रॉ को पारदर्शी और आसान बनाने के लिए है। आप एक विजेता चुन सकते हैं या नीचे संख्या दर्ज करके एक साथ कई विजेता चुन सकते हैं।",
    participants: "प्रतिभागी",
    addFile: "फ़ाइल जोड़ें",
    clearTitle: "सूची साफ़ करें",
    settingsTitle: "सेटिंग्स",
    theme: "रंग थीम",
    duration: "अवधि",
    seconds: "सेकंड",
    removeWinner: "विजेता को सूची से हटा दें (दोबारा नहीं आएगा)",
    removeWinnerShort: "विजेता को सूची से हटा दें",
    confetti: "जश्न (Confetti)",
    done: "संपन्न",
    ready: "तैयार?",
    winnerLabel: "विजेता है",
    currentPickLabel: "वर्तमान चयन",
    spinning: "चयन हो रहा है...",
    reset: "फिर से शुरू करें",
    pickOne: "विजेता चुनें",
    pickMulti: "{n} विजेता चुनें",
    numWinners: "विजेताओं की संख्या:",
    recent: "हालिया इतिहास",
    winnersList: "विजेताओं की सूची",
    placeholder: "यहाँ नाम दर्ज करें, प्रति पंक्ति एक...",
    alertEmpty: "कृपया पहले कुछ नाम दर्ज करें!",
    alertCount: "आपने {n} विजेताओं के लिए कहा लेकिन सूची में केवल {t} लोग हैं।",
    alertMin: "कम से कम 1 विजेता आवश्यक है।",
    confirmClear: "क्या आप पूरी सूची साफ़ करना चाहते हैं?",
    uploadError: "फ़ाइल पढ़ने में त्रुटि",
    uploadBtn: "फ़ाइल",
    footer: "लकी ड्रॉ • एक्सेल सपोर्ट • मल्टी-विजेता"
  }
};

const loadScripts = () => {
  if (!window.confetti) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
    document.body.appendChild(script);
  }
  if (!window.XLSX) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.body.appendChild(script);
  }
};

export default function App() {
  // --- STATE ---
  const [lang, setLang] = useState('ur'); // Default Language: Urdu
  const [namesInput, setNamesInput] = useState('Ali\nUsman\nFatima\nZainab\nBilal\nHassan\nAyesha\nOmar\nHamza\nSaad');
  const [winner, setWinner] = useState(null);
  const [multipleWinners, setMultipleWinners] = useState([]);
  const [winnersCount, setWinnersCount] = useState(1);
  const [removeWinner, setRemoveWinner] = useState(false);
  
  const [isSpinning, setIsSpinning] = useState(false);
  const [currentDisplay, setCurrentDisplay] = useState(translations[lang].ready);
  const [history, setHistory] = useState([]);
  const [showSettings, setShowSettings] = useState(false);
  const [uploadError, setUploadError] = useState(null);

  const textareaRef = useRef(null);
  const lineNumbersRef = useRef(null);
  const fileInputRef = useRef(null);

  const [settings, setSettings] = useState({
    theme: 'emerald',
    duration: 3000,
    enableConfetti: true,
  });

  const t = translations[lang];
  const isRTL = lang === 'ur' || lang === 'ar'; 

  // --- Font Logic ---
  const getFontFamily = () => {
    switch (lang) {
      case 'ur': return "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif";
      case 'ar': return "'Batool', 'Amiri', serif";
      case 'hi': return "'Noto Sans Devanagari', sans-serif";
      default: return "'Noto Sans', sans-serif";
    }
  };

  // Fixed line height class for both input and line numbers
  // This ensures perfect alignment
  const getLineHeightClass = () => {
      // 2.2em for Urdu/Arabic to accommodate Nastaleeq height, normal for others
      return lang === 'ur' || lang === 'ar' ? 'leading-[2.2rem]' : 'leading-relaxed';
  };

  useEffect(() => {
    loadScripts();
    if (!winner && multipleWinners.length === 0 && !isSpinning) {
        setCurrentDisplay(translations[lang].ready);
    }
  }, [lang]);

  const handleScroll = () => {
    if (textareaRef.current && lineNumbersRef.current) {
      lineNumbersRef.current.scrollTop = textareaRef.current.scrollTop;
    }
  };

  const getThemeColors = () => {
    switch (settings.theme) {
      case 'rose': return { bg: 'bg-rose-50', button: 'bg-rose-600 hover:bg-rose-700', text: 'text-rose-900', border: 'border-rose-200', accent: 'text-rose-600', ring: 'focus:ring-rose-500', badge: 'bg-rose-100 text-rose-800', checkbox: 'text-rose-600' };
      case 'indigo': return { bg: 'bg-indigo-50', button: 'bg-indigo-600 hover:bg-indigo-700', text: 'text-indigo-900', border: 'border-indigo-200', accent: 'text-indigo-600', ring: 'focus:ring-indigo-500', badge: 'bg-indigo-100 text-indigo-800', checkbox: 'text-indigo-600' };
      case 'slate': return { bg: 'bg-slate-100', button: 'bg-slate-800 hover:bg-slate-900', text: 'text-slate-900', border: 'border-slate-300', accent: 'text-slate-800', ring: 'focus:ring-slate-500', badge: 'bg-slate-200 text-slate-800', checkbox: 'text-slate-800' };
      default: return { bg: 'bg-emerald-50', button: 'bg-emerald-600 hover:bg-emerald-700', text: 'text-emerald-900', border: 'border-emerald-200', accent: 'text-emerald-600', ring: 'focus:ring-emerald-500', badge: 'bg-emerald-100 text-emerald-800', checkbox: 'text-emerald-600' };
    }
  };
  const theme = getThemeColors();

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const fileType = file.name.split('.').pop().toLowerCase();
    setUploadError(null);

    const processContent = (content) => {
        if (content.trim().length > 0) {
            setNamesInput(prev => prev ? prev + '\n' + content : content);
        } else {
            setUploadError(t.uploadError);
        }
    };

    if (fileType === 'xlsx' || fileType === 'xls') {
        if (!window.XLSX) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const data = new Uint8Array(evt.target.result);
                const workbook = window.XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processContent(jsonData.flat().filter(n => n).join('\n'));
            } catch (err) { setUploadError(t.uploadError); }
        };
        reader.readAsArrayBuffer(file);
    } else if (fileType === 'txt' || fileType === 'csv') {
        const reader = new FileReader();
        reader.onload = (evt) => processContent(evt.target.result);
        reader.readAsText(file);
    } else {
        setUploadError(t.uploadError);
    }
    e.target.value = '';
  };

  const getCleanNames = () => namesInput.split('\n').map(n => n.trim()).filter(n => n.length > 0);
  const lineNumbers = namesInput.split('\n').map((_, i) => i + 1);

  const fireConfetti = () => {
    if (window.confetti && settings.enableConfetti) {
      window.confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }
  };

  const startProcess = () => {
    const names = getCleanNames();
    
    if (names.length === 0) { alert(t.alertEmpty); return; }
    if (winnersCount > names.length) { alert(t.alertCount.replace('{n}', winnersCount).replace('{t}', names.length)); return; }
    if (winnersCount < 1) { alert(t.alertMin); return; }

    setIsSpinning(true);
    setWinner(null);
    setMultipleWinners([]);
    setShowSettings(false);

    if (winnersCount === 1) {
        let counter = 0;
        const intervalTime = 80;
        const totalLoops = Math.floor(settings.duration / intervalTime);
        const interval = setInterval(() => {
          const randomIndex = Math.floor(Math.random() * names.length);
          setCurrentDisplay(names[randomIndex]);
          counter++;
          if (counter >= totalLoops) {
            clearInterval(interval);
            finalizeSingleWinner(names);
          }
        }, intervalTime);
    } else {
        setCurrentDisplay(t.spinning);
        setTimeout(() => {
            finalizeMultipleWinners(names);
        }, settings.duration);
    }
  };

  const finalizeSingleWinner = (currentNames) => {
    const finalIndex = Math.floor(Math.random() * currentNames.length);
    const winningName = currentNames[finalIndex];
    
    setCurrentDisplay(winningName);
    setWinner(winningName);
    setIsSpinning(false);
    setHistory(prev => [winningName, ...prev]);
    fireConfetti();
    handleRemoval([finalIndex], currentNames);
  };

  const finalizeMultipleWinners = (currentNames) => {
    const shuffled = [...currentNames].sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, winnersCount);
    
    setMultipleWinners(selected);
    setIsSpinning(false);
    setCurrentDisplay(`${t.winnerLabel}!`);
    setHistory(prev => [...selected, ...prev]);
    fireConfetti();

    if (removeWinner) {
        const newNames = currentNames.filter(n => !selected.includes(n));
        setNamesInput(newNames.join('\n'));
    }
  };

  const handleRemoval = (indicesToRemove, allNames) => {
      if (removeWinner) {
          const newNames = allNames.filter((_, idx) => !indicesToRemove.includes(idx));
          setNamesInput(newNames.join('\n'));
      }
  };

  const handleClear = () => {
    if(confirm(t.confirmClear)) {
        setNamesInput(''); setWinner(null); setMultipleWinners([]); setCurrentDisplay(t.ready);
    }
  };

  const handleReset = () => {
    setWinner(null);
    setMultipleWinners([]);
    setCurrentDisplay(t.ready);
  };

  return (
    <>
    {/* Loading Google Fonts */}
    <style dangerouslySetInnerHTML={{__html: `
      @import url('https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Nastaliq+Urdu:wght@400;700&family=Noto+Sans:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap');
    `}} />

    <div 
        dir={isRTL ? "rtl" : "ltr"} 
        className={`min-h-screen ${theme.bg} ${theme.text} flex flex-col items-center justify-center p-4 transition-colors duration-500`}
        style={{ fontFamily: getFontFamily() }}
    >
      
      {/* LANGUAGE SELECTOR */}
      <div className="absolute top-4 right-4 z-50 font-sans">
        <div className="relative group">
            <button className={`flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50 text-sm font-bold ${theme.text}`}>
                <Globe size={16} />
                {lang === 'ur' ? 'اردو' : lang === 'ar' ? 'العربية' : lang === 'hi' ? 'हिंदी' : 'English'}
            </button>
            <div className={`absolute top-full right-0 mt-2 w-32 bg-white rounded-lg shadow-lg border border-gray-100 overflow-hidden hidden group-hover:block`}>
                <button onClick={() => setLang('ur')} className="block w-full text-right px-4 py-2 text-sm hover:bg-gray-50 font-[Jameel Noori Nastaleeq]">اردو</button>
                <button onClick={() => setLang('en')} className="block w-full text-left px-4 py-2 text-sm hover:bg-gray-50 font-sans">English</button>
                <button onClick={() => setLang('ar')} className="block w-full text-right px-4 py-2 text-sm hover:bg-gray-50 font-[Amiri]">العربية</button>
                <button onClick={() => setLang('hi')} className="block w-full text-left px-4 py-2 text-sm hover:bg-gray-50 font-sans">हिंदी</button>
            </div>
        </div>
      </div>

      <div className="text-center mb-6 max-w-2xl w-full mt-10 md:mt-0">
        <h1 className={`text-4xl font-extrabold mb-2 ${theme.accent} tracking-tight ${getLineHeightClass()}`}>
          {t.title}
        </h1>
        <p className={`opacity-70 text-lg font-medium mb-4 ${getLineHeightClass()}`}>{t.subtitle}</p>
        
        <div className="bg-white/60 backdrop-blur-md rounded-xl p-4 text-sm text-gray-600 border border-white/50 shadow-sm mx-auto">
          <p className={`flex items-start gap-2 justify-center ${getLineHeightClass()}`}>
            <Info className="shrink-0 mt-2 opacity-70" size={16} />
            <span>{t.info}</span>
          </p>
        </div>
      </div>

      <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div className={`bg-white rounded-2xl shadow-xl p-6 flex flex-col relative overflow-hidden ${isRTL ? 'text-right' : 'text-left'}`}>
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-lg font-bold flex items-center gap-2">
              <Users size={20} /> {t.participants} ({getCleanNames().length})
            </h2>
            <div className="flex gap-2 items-center">
              <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".txt,.csv,.xlsx,.xls" className="hidden" />
              <button onClick={() => fileInputRef.current.click()} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition flex items-center gap-1" title={t.addFile}>
                <FileSpreadsheet size={18} />
                <span className="text-xs font-bold hidden sm:inline">{t.uploadBtn}</span>
              </button>
              <button onClick={handleClear} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition" title={t.clearTitle}>
                <Trash2 size={18} />
              </button>
              <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full transition ${showSettings ? 'bg-gray-100' : 'text-gray-400 hover:bg-gray-100'}`} title={t.settingsTitle}>
                <Settings size={18} />
              </button>
            </div>
          </div>
          
          {uploadError && <div className="mb-2 text-xs text-red-500 bg-red-50 p-2 rounded">{uploadError}</div>}

          <div className="flex-grow relative h-64">
            {showSettings ? (
              <div className="absolute inset-0 bg-white z-10 animate-in fade-in zoom-in-95 duration-200 p-2">
                <div className={`space-y-6 ${getLineHeightClass()}`}>
                  <div>
                    <label className="block text-lg font-bold mb-2">{t.theme}</label>
                    <div className="flex gap-3">
                      {['emerald', 'indigo', 'rose', 'slate'].map(c => (
                        <button key={c} onClick={() => setSettings({...settings, theme: c})} className={`w-8 h-8 rounded-full border-2 ${settings.theme === c ? 'border-gray-900 scale-110' : 'border-transparent'} shadow-sm`} style={{ backgroundColor: c === 'indigo' ? '#4f46e5' : c === 'rose' ? '#e11d48' : c === 'emerald' ? '#059669' : '#475569' }} />
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="block text-lg font-bold mb-2">{t.duration}: {settings.duration / 1000} {t.seconds}</label>
                    <input type="range" min="1000" max="10000" step="500" value={settings.duration} onChange={(e) => setSettings({...settings, duration: Number(e.target.value)})} className="w-full accent-gray-600" />
                  </div>
                  <div className="flex items-center justify-between">
                    <label className="text-lg font-semibold">{t.confetti}</label>
                    <input type="checkbox" checked={settings.enableConfetti} onChange={(e) => setSettings({...settings, enableConfetti: e.target.checked})} className={`w-5 h-5 rounded ${theme.checkbox}`} />
                  </div>
                  <button onClick={() => setShowSettings(false)} className="w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm mt-4">{t.done}</button>
                </div>
              </div>
            ) : (
              // TEXT AREA AND LINE NUMBERS - NOW WITH MATCHING FONT & HEIGHT
              <div className={`relative flex w-full h-full rounded-xl border-2 ${theme.border} bg-gray-50 overflow-hidden ${theme.ring} focu
